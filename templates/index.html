<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DorkNet CryptoVault - Terminal Sécurisé</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #00ff41; --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --danger: #f85149; --info: #58a6ff; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Courier New', Courier, monospace; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 50px 20px; }
        .container { background: var(--card); padding: 2.5rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.7); width: 100%; max-width: 850px; border: 1px solid var(--border); }
        .banner { text-align: center; margin-bottom: 30px; border: 2px solid var(--primary); padding: 20px; border-radius: 8px; background: rgba(0, 255, 65, 0.05); }
        h1 { margin: 0; font-size: 2rem; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 255, 65, 0.5); }
        h3 { border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid var(--border); background: #0d1117; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: black; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; text-transform: uppercase; }
        button:hover { background: #00cc33; filter: brightness(1.2); box-shadow: 0 0 15px rgba(0, 255, 65, 0.4); }
        .btn-sm-action { text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--primary); color: var(--primary); transition: 0.3s; display: inline-block; background: transparent; }
        .btn-sm-action:hover { background: var(--primary); color: black; }
        .btn-csv { text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--info); color: var(--info); transition: 0.3s; display: inline-block; margin-right: 5px; }
        .btn-csv:hover { background: var(--info); color: white; }
        .flash { padding: 12px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .flash-success { background: rgba(0, 43, 54, 0.8); border: 1px solid var(--primary); color: var(--primary); }
        .flash-danger { background: rgba(45, 0, 0, 0.8); border: 1px solid var(--danger); color: var(--danger); }
        .logout-link { color: var(--danger); text-decoration: none; font-size: 0.9rem; float: right; cursor: pointer; font-weight: bold; }
        .log-container { background-color: #0a0a0a; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; color: var(--text); }
        th { text-align: left; border-bottom: 1px solid #333; padding: 10px; color: var(--primary); }
        td { padding: 10px; border-bottom: 1px solid #1a1a1a; vertical-align: middle; }
        .badge { background: #003311; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--primary); font-size: 0.75rem; }
        .neon-text { text-align: center; margin: 30px 0; color: #F5F5F5; font-weight: bold; text-shadow: 0 0 10px #00d4ff; letter-spacing: 2px; }
        #encryption-status { font-size: 0.8rem; color: #e1b12c; display: none; margin-top: 5px; }
        
        .modal-content { background-color: var(--card) !important; border: 1px solid var(--info) !important; color: var(--text) !important; }
        .stats-card { background: rgba(88, 166, 255, 0.05); border: 1px solid var(--info); padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        .timeline-card { background: rgba(0, 255, 65, 0.02); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="banner">
            <h1><i class="fas fa-network-wired"></i> DORKNET <span style="font-weight: 300;">CRYPTOVAULT</span></h1>
            <small style="color: var(--primary); letter-spacing: 5px; display: block; margin-top: 10px;">CRYPTOGRAPHIC VAULT v2.0</small>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}{% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}{% endif %}
        {% endwith %}

        {% if current_user.is_authenticated %}
            <div class="user-panel">
                <a href="javascript:void(0);" onclick="confirmLogout()" class="logout-link">
                    <i class="fas fa-sign-out-alt"></i> Quitter
                </a>
                <p>Opérateur: <span style="color:var(--primary); font-weight: bold;">{{ current_user.username }}</span></p>

                <div class="stats-card text-center">
                    <h6 class="text-info text-uppercase small mb-1">Intégrité du Bastion</h6>
                    <h2 class="display-6 font-monospace m-0" style="color: var(--info);">{{ log_count }}</h2>
                    <span class="text-secondary small">Événements enregistrés par le Dr Enoch Numbi</span>
                    
                    <div class="timeline-card text-start">
                        <h6 style="color: var(--info); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 15px;">
                            <i class="fas fa-chart-line me-2"></i>Activité du Bastion (24h)
                        </h6>
                        <canvas id="activityChart" height="120"></canvas>
                    </div>
                </div>
                
                <section style="margin-top: 30px;">
                    <h3><i class="fas fa-lock"></i> Chiffrement Client-Side AES-256</h3>
                    <form id="secure-upload-form">
                        <input type="file" id="file-input" required>
                        <input type="password" id="client-pass" placeholder="Clé de chiffrement locale (Secret RAM)" required>
                        <button type="submit" id="btn-upload">Lancer le Chiffrement & Upload</button>
                        <div id="encryption-status"><i class="fas fa-spinner fa-spin"></i> Chiffrement local en cours...</div>
                    </form>
                </section>

                <section style="margin-top: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); margin-bottom: 10px;">
                        <h3 style="border:none;"><i class="fas fa-cloud"></i> Archives Cloud</h3>
                        <div>
                            <a href="{{ url_for('export_logs') }}" class="btn-csv" title="Exporter les logs"><i class="fas fa-file-csv"></i></a>
                            <a href="{{ url_for('admin_logs') }}" class="btn-sm-action">Panel Admin</a>
                        </div>
                    </div>
                    <table>
                        <thead><tr><th>Archive (.enc)</th><th>Taille</th><th style="text-align: right;">Actions</th></tr></thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td style="color: #aaa; font-size: 0.75rem;">
                                    <i class="fas fa-file-shield text-warning me-2"></i>{{ file.public_id }}
                                </td>
                                <td>{{ file.size }}</td>
                                <td style="text-align: right;">
                                    <button onclick="openVisualizer('{{ file.public_id }}')" class="btn-sm-action me-1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{{ url_for('download_cloud', public_id=file.public_id) }}" class="btn-sm-action"><i class="fas fa-file-download"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </section>

                <section style="margin-top: 40px;">
                    <h3><i class="fas fa-list-ul"></i> Journal d'Audit</h3>
                    <div class="log-container">
                        <table>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td style="color: #666; width: 80px;">{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                                    <td><span class="badge">{{ log.action }}</span></td>
                                    <td style="color: #aaa;">{{ log.details }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        {% else %}
            <div class="auth-panel">
                <form action="/login" method="post">
                    <h3>Identification</h3>
                    <input type="text" name="username" placeholder="Pseudo Opérateur" required>
                    <input type="password" name="password" placeholder="Mot de passe" required>
                    <button type="submit">Accéder au Terminal</button>
                </form>
                <div class="neon-text">[ INITIALISATION ]</div>
                <form action="{{ url_for('register') }}" method="post">
                    <input type="text" name="username" placeholder="Pseudo" required>
                    <input type="password" name="password" placeholder="Mot de passe" required>
                    <input type="password" name="pin" placeholder="PIN 2FA" maxlength="6" required>
                    <button type="submit" style="background:#21262d; color:var(--primary); border: 1px solid var(--primary);">Générer Accès</button>
                </form>
            </div>
        {% endif %}
    </div>

    <div class="modal fade" id="visualizerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="border-bottom: 1px solid var(--info);">
                    <h5 class="modal-title" style="color: var(--info);"><i class="fas fa-unlock me-2"></i>Visualiseur ZK-RAM</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="keyInputArea">
                        <p class="small text-secondary mb-3">Saisissez votre clé pour déchiffrer l'image en RAM.</p>
                        <input type="password" id="aesKey" placeholder="Clé AES secrète" style="border-color: var(--info); color: var(--info);">
                        <button onclick="processDecryption()" style="background: var(--info); color: white;">Déchiffrer</button>
                    </div>
                    <div id="imageDisplayArea" class="d-none">
                        <img id="decryptedImage" src="" class="img-fluid rounded border border-secondary shadow">
                        <p class="text-warning small mt-3"><i class="fas fa-biohazard"></i> Donnée volatile : Non stockée sur le disque.</p>
                    </div>
                    <div id="loader" class="d-none py-4"><i class="fas fa-sync fa-spin fa-2x text-info"></i></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmLogout() {
            if (confirm("⚠️ Alerte : Fermer la session DorkNet ?")) {
                window.location.href = "{{ url_for('logout') }}";
            }
        }

        // --- GRAPHique D'ACTIVITÉ ---
        const ctx = document.getElementById('activityChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: {{ labels|tojson if labels else '[]' }},
                    datasets: [{
                        label: 'Activités',
                        data: {{ values|tojson if values else '[]' }},
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#161b22' }, ticks: { color: '#8b949e', font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { color: '#8b949e', font: { size: 10 } } }
                    }
                }
            });
        }

        // --- LOGIQUE VISUALISEUR ---
        let currentFile = "";
        function openVisualizer(publicId) {
            currentFile = publicId;
            document.getElementById('keyInputArea').classList.remove('d-none');
            document.getElementById('imageDisplayArea').classList.add('d-none');
            document.getElementById('aesKey').value = "";
            new bootstrap.Modal(document.getElementById('visualizerModal')).show();
        }

        async function processDecryption() {
            const key = document.getElementById('aesKey').value;
            if (!key) return alert("Clé requise !");
            const loader = document.getElementById('loader');
            loader.classList.remove('d-none');
            document.getElementById('keyInputArea').classList.add('d-none');

            try {
                const response = await fetch(`/get_raw_file/${currentFile}`);
                const encryptedData = await response.text();
                const decrypted = CryptoJS.AES.decrypt(encryptedData, key).toString(CryptoJS.enc.Utf8);
                
                if (!decrypted || !decrypted.startsWith('data:image')) {
                    throw new Error("Clé incorrecte ou format non supporté.");
                }
                document.getElementById('decryptedImage').src = decrypted;
                document.getElementById('imageDisplayArea').classList.remove('d-none');
            } catch (e) {
                alert("Erreur : " + e.message);
                document.getElementById('keyInputArea').classList.remove('d-none');
            } finally { loader.classList.add('d-none'); }
        }

        // --- LOGIQUE UPLOAD HARMONISÉE ---
        async function encryptFileBeforeUpload(file, userKey) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const encrypted = CryptoJS.AES.encrypt(reader.result, userKey).toString();
                    resolve(new Blob([encrypted], {type: "text/plain"}));
                };
                reader.readAsDataURL(file);
            });
        }

        const form = document.getElementById('secure-upload-form');
        if(form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fInput = document.getElementById('file-input');
                const kInput = document.getElementById('client-pass');
                const status = document.getElementById('encryption-status');
                if (fInput.files.length > 0) {
                    status.style.display = 'block';
                    const blob = await encryptFileBeforeUpload(fInput.files[0], kInput.value);
                    const formData = new FormData();
                    formData.append('file', blob, fInput.files[0].name + '.enc');
                    const response = await fetch('/upload', { method: 'POST', body: formData });
                    if (response.ok) { window.location.reload(); }
                    else { alert("Échec de l'upload"); status.style.display = 'none'; }
                }
            });
        }
    </script>
</body>
</html>
